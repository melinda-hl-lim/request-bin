name: SSH test

on: 
  pull_request:
    types: [opened, edited, reopened]
env:
  IMAGE_NAME: request-bin-api
  IMAGE_DIR: server
  DOCKER_USER: sjbabadi

jobs:
  build-and-push:
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v1
      - name: Publish to registry
        uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: $DOCKER_USER/#IMAGE_NAME
          username: $DOCKER_USER
          password: ${{  secrets.DOCKER_PASSWORD }}
          workdir: $IMAGE_DIR

  access_droplet:
    runs-on: ubuntu-18.04
    steps:
      - name: Executing remote script
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd request-bin
            docker-compose up --build -d

          